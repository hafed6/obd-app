<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ´Ø®ÙŠØµ Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
      text-align: center;
      padding-top: 80px;
      direction: rtl;
    }
    h1 {
      color: #333;
    }
    button {
      padding: 15px 30px;
      font-size: 18px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background-color: #004c99;
    }
    #status {
      margin-top: 30px;
      font-size: 18px;
      color: #222;
      white-space: pre-wrap;
      word-wrap: break-word;
      padding: 20px;
    }
  </style>
</head>
<body>

  <h1>ğŸ”§ ØªØ´Ø®ÙŠØµ Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h1>
  <button onclick="connectToOBD()">ğŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù‡Ø§Ø² OBD</button>
  <div id="status">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...</div>

  <script>
    const deviceProfiles = [
      {
        nameMatch: "Thinkcar",
        serviceUUID: "0000fff0-0000-1000-8000-00805f9b34fb",
        characteristicUUID: "0000fff1-0000-1000-8000-00805f9b34fb"
      },
      {
        nameMatch: "OBDLink",
        serviceUUID: "0000ffe0-0000-1000-8000-00805f9b34fb",
        characteristicUUID: "0000ffe1-0000-1000-8000-00805f9b34fb"
      },
      {
        nameMatch: "VEEPEAK",
        serviceUUID: "0000ffe0-0000-1000-8000-00805f9b34fb",
        characteristicUUID: "0000ffe1-0000-1000-8000-00805f9b34fb"
      }
    ];

    async function connectToOBD() {
      const status = document.getElementById('status');
      status.innerText = 'ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù‡Ø§Ø² OBD...';

      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: deviceProfiles.map(p => p.serviceUUID)
        });

        const profile = deviceProfiles.find(p =>
          device.name && device.name.includes(p.nameMatch)
        );

        if (!profile) {
          status.innerText = `âŒ Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…: ${device.name}`;
          return;
        }

        status.innerText = `âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²: ${device.name}\nğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...`;

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(profile.serviceUUID);
        const characteristic = await service.getCharacteristic(profile.characteristicUUID);

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', handleResponse);

        // Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ù„Ù‚Ø±Ø§Ø¡Ø© Ø±Ù…ÙˆØ² Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ (03)
        const encoder = new TextEncoder();
        const command = encoder.encode("03\r");
        await characteristic.writeValue(command);

        status.innerText += `\nâ³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²...`;

      } catch (error) {
        status.innerText = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error;
      }
    }

    function handleResponse(event) {
      const value = event.target.value;
      const decoder = new TextDecoder();
      const response = decoder.decode(value);

      const status = document.getElementById('status');
      status.innerText += `\nğŸ“Ÿ Ø§Ø³ØªØ¬Ø§Ø¨Ø©:\n${response}`;

      const dtcs = parseDTCResponse(response);
      if (dtcs.length > 0) {
        status.innerText += `\nğŸ” Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:\n- ${dtcs.join("\n- ")}`;
      } else {
        status.innerText += `\nâœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø·Ø§Ù„ Ù…Ø³Ø¬Ù„Ø©.`;
      }
    }

    function parseDTCResponse(response) {
      const lines = response.split('\n').map(l => l.trim()).filter(Boolean);
      const hexData = lines.join('').replace(/[\s\r>]/g, '');

      if (!hexData.startsWith("43")) return [];

      const codes = [];
      let i = 2;
      while (i + 4 <= hexData.length) {
        const code = hexData.slice(i, i + 4);
        if (code === "0000") break;
        codes.push(decodeDTC(code));
        i += 4;
      }

      return codes;
    }

    function decodeDTC(code) {
      const chars = ['P', 'C', 'B', 'U'];
      const b1 = parseInt(code[0], 16);
      const type = chars[(b1 & 0xC) >> 2];
      const firstDigit = b1 & 0x3;
      return `${type}${firstDigit}${code.slice(1)}`;
    }
  </script>
</body>
</html>
